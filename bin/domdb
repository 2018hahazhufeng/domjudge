#!/bin/bash

# - status: check current status
# 
# - install: genpasswords if not existing, create database + contents if not
#   existing, create users if not existing
# - genpass: generate passwords
# - setup:  create database, setup users and permissions
# - create: create tables etc

set -e

for path in "@DBLIB_PATH@" "`dirname $0`"; do
	if [ -e "$path" ]; then
		. "$path/paths.sh"
	fi
done

function query
{
	mysql --silent --skip-column-names -e "$@"
}

function parsedbini
{
	local OLDIFS="$IFS"
	IFS="$IFS="
	# grep all non-empty lines that do not start with # as the first
	# non-whitespace character
	egrep '^[[:space:]]*[^#[:space:]]' database.ini | \
	while read key value; do
		case "$key" in
		host)        DBHOST="$value" ;;
		database)    DBNAME="$value" ;;
		user.jury)   DBUSER_JURY="$value" ;;
		user.team)   DBUSER_TEAM="$value" ;;
		user.public) DBUSER_PUBLIC="$value" ;;
		user.worker) DBUSER_JUDGEHOST="$value" ;;
		*)
			echo "Parse error: Unknown key '$key' in database.ini" >&2
			exit 1
			;;
		esac
	done
	IFS="$OLDIFS"
}

case "$1" in

status)
	parsedbini
	for user in jury team public judgehost; do
		eval 'theuser=$DBUSER_'$user
		echo -n "Trying to connect to the server with user $theuser for role $user:"
		mysql -u $user -p
	done
	if [ ! query 'select "Success!";' ]; then
		echo "Could not connect to the MySQL server."
		echo "Make sure that you configured the MySQL client"
		echo "correctly, see /etc/mysql/my.cnf or ~/.my.cnf"
		echo ""
		echo "Specifically, ensure you configure "
	fi

	#echo -n "MySQL server version: "
	#query 'select version();'
	;;

genpass)
	$DBETC_PATH/gendbpass > /dev/null
	;;

setup)
	# Needed: host, database, rootuser, rootpass

	;;
*)
	echo "Unknown subcommand" >&2
	echo "Usage:"
	echo "domdb <cmd> [<database> [<mysql_options>]]"
	echo 
	echo "Commands:"
	echo "- status: Check status"
	exit 1
	;;

esac

