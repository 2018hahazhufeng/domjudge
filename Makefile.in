# Main Makefile
#
# $Id$

# Define TOPDIR from shell command and _not_ $(PWD) because that gives
# pwd before changing to a 'make -C <dir>' <dir>:
export TOPDIR = $(shell pwd)

# Global Makefile definitions
include $(TOPDIR)/Makefile.global

default:
	@echo "No default target"
	@echo
	@echo "Try:"
	@echo " - make domserver"
	@echo " - make judgehost"
	@echo " - make db"
	@echo " - make submitclient"
	@echo " - make docs"
	@echo or
	@echo " - make install-domserver"
	@echo " - make install-judgehost"
	@echo " - make install-db"
	@echo " - make install-submitclient"
	@echo or
	@echo " - make clean"
	@echo " - make distclean"
	@exit 1

# MAIN TARGETS
team: submitclient
doc: docs
domserver:
install-domserver: domserver
judgehost:
install-judgehost: judgehost

# List all targets that exist in subdirs too, and optionally list in
# which subdirs they are, overriding default SUBDIRS list.
REC_TARGETS=domserver install-domserver judgehost install-judgehost \
            submitclient docs clean distclean
SUBDIRS=bin doc etc judge lib sql submit www test-programs test-sources

submitclient:      SUBDIRS=submit
docs:              SUBDIRS=doc
domserver:         SUBDIRS=etc submit
install-domserver: SUBDIRS=etc lib submit www
judgehost:         SUBDIRS=bin etc judge
install-judgehost: SUBDIRS=bin etc judge lib

install-domserver: domserver-create-dirs
install-judgehost: judgehost-create-dirs

domserver-create-dirs:
	install -d @domserver_etcdir@    @domserver_libdir@ \
	           @domserver_libwwwdir@ @domserver_wwwdir@ \
	           @domserver_logdir@    @domserver_tmpdir@

judgehost-create-dirs:
	install -d @judgehost_bindir@   @judgehost_etcdir@ \
	           @judgehost_libdir@   @judgehost_libjudgedir@ \
	           @judgehost_judgedir@ @judgehost_logdir@

# Global dependencies:
#submitclient: config

$(REC_TARGETS): %:
	for dir in $(SUBDIRS) ; do $(MAKE) -C $$dir $@ || exit 1 ; done

.PHONY: team doc domserver-create-dirs judgehost-create-dirs
