ifndef TOPDIR
TOPDIR=..
endif
include $(TOPDIR)/Makefile.global

domserver: apache.conf dbpasswords.secret
judgehost: dbpasswords.secret

dbpasswords.secret:
	echo "Randomly generated on host `hostname`, `date`" > dbpasswords.secret
	chmod go= dbpasswords.secret
	./gendbpasswords >> dbpasswords.secret

apache.conf: apache.conf.in Makefile
	cat $< | \
	sed -e "1i # Warning: this file was generated from '$<' by make." \
	    -e "1a # Don't edit this file, edit '$<' instead." \
	    -e "s,@domserver_wwwdir[@],@domserver_wwwdir@,g" \
	    -e "s,@domserver_etcdir[@],@domserver_etcdir@,g" \
	    -e "s,@domserver_hostname[@],@domserver_hostname@,g" > $@

install-domserver:
	install -d @domserver_etcdir@
	install -t @domserver_etcdir@ apache.conf domserver-static.php domserver-config.php
	install -m u=rw,go= dbpasswords.secret @domserver_etcdir@

install-judgehost:
	install -d @judgehost_etcdir@
	install -t @judgehost_etcdir@ judgehost-static.php judgehost-config.php judgehost-config.sh
	install -m u=rw,go= dbpasswords.secret @judgehost_etcdir@

permissions-domserver:
	ensurepermission group @webservergroup@ @domserver_etcdir@/dbpasswords.secret
	ensurepermission perm g=r,o=            @domserver_etcdir@/dbpasswords.secret

