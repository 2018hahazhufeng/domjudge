domserver: apache.conf dbpasswords.secret

dbpasswords.secret:
	echo "Randomly generated on host `hostname`, `date`" > dbpasswords.secret
	chmod go= dbpasswords.secret
	./gendbpasswords > dbpasswords.secret

apache.conf: apache.conf.in
	cat apache.conf.in | \
		sed '1i # Warning: this file is generated from apache.conf.in' | \
		sed '1a # by make. Edit apache.conf.in instead.' | \
		sed 's,@domserverwww_path[@],@domserverwww_path@,g'  | \
		sed 's,@domserver_hostname[@],@domserver_hostname@,g' > \
		apache.conf

install-domserver:
	install -d @domserverconf_path@
	install apache.conf @domserverconf_path@
	install domserver-config.php @domserverconf_path@
	install -m go= dbpasswords.secret @domserverconf_path@

permissions-domserver:
	ensurepermission group @webservergroup@ @domserverconf_path@/dbpasswords.secret
	ensurepermission perm g=r,o=            @domserverconf_path@/dbpasswords.secret


.PHONY: domserver install-domserver
