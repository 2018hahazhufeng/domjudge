ifndef TOPDIR
TOPDIR=..
endif
include $(TOPDIR)/Makefile.global

domserver: apache.conf dbpasswords.secret
judgehost: dbpasswords.secret

dbpasswords.secret:
	echo "Randomly generated on host `hostname`, `date`" > dbpasswords.secret
	chmod go= dbpasswords.secret
	./gendbpasswords >> dbpasswords.secret

apache.conf: apache.conf.in
	cat apache.conf.in | \
		sed '1i # Warning: this file is generated from apache.conf.in' | \
		sed '1a # by make. Edit apache.conf.in instead.' | \
		sed 's,@domserver_wwwdir[@],@domserver_wwwdir@,g'  | \
		sed 's,@domserver_etcdir[@],@domserver_etcdir@,g'  | \
		sed 's,@domserver_hostname[@],@domserver_hostname@,g' > \
		apache.conf

install-domserver:
	install -d @domserver_etcdir@
	install -t @domserver_etcdir@ apache.conf domserver-static.php domserver-config.php
	install -m u=rw,go= dbpasswords.secret @domserver_etcdir@

install-judgehost:
	install -d @judgehost_etcdir@
	install -t @judgehost_etcdir@ judgehost-static.php judgehost-config.php judgehost-config.sh
	install -m u=rw,go= dbpasswords.secret @judgehost_etcdir@

permissions-domserver:
	ensurepermission group @webservergroup@ @domserver_etcdir@/dbpasswords.secret
	ensurepermission perm g=r,o=            @domserver_etcdir@/dbpasswords.secret

